---
# tasks file for yum_updates
# Yum update followed by reboot
# Then compair Kernel versions if different trigger reboot
# Then wait for boxes to come back up by monitoring ssh port connection
#
- name: Perform yum update
  yum: name=* state=latest update_cache=yes
  tags: patch

- name: Compair Kernel versions
  shell: if [ $(rpm -q kernel --queryformat '%{installtime} %{version}-%{release}.%{arch}\n' | sort -n -k1 | tail -1 | cut -d ' ' -f 2) != $(uname -r) ]; then echo 'reboot'; else echo 'no'; fi
  ignore_errors: true
  register: reboot_hint
  tags: reboot

- set_fact:
  # reboot_required: "{% if reboot_hint.stdout == 'reboot' %} 'reboot' {% else %} 'no' {% endif %}"
    reboot_required: 'reboot'

- debug:
    msg: "Reboot: {{ reboot_required }}"
 
- name: Rebooting {{ inventory_hostname }}
  command: "/sbin/shutdown -r +1"
  async: 0
  poll: 0
  become: true
  ignore_errors: true
  when: reboot_required=="reboot"
  register: rebooting

- name: Reboot | Wait for {{ inventory_hostname }} to come up
    # wait_for host={{ inventory_hostname }} port=22 state=started delay=30 timeout=600
  wait_for:
    host: "{{ inventory_hostname }}"
    port: 22
    delay: 20
    timeout: 600
  register: timeup
  become: false
  delegate_to: 127.0.0.1
  when:  reboot_required=="reboot"

- debug: 
    msg: "Up after {{ timeup.elapsed }} seconds"
  when: reboot_required=="reboot"
